<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>formGenerator</title>
    
    <link href="./formGenerator_files/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="./formGenerator_files/fileinput.css" rel="stylesheet" type="text/css">
    <link href="./formGenerator_files/all.css" rel="stylesheet" type="text/css">
    <link href="./formGenerator_files/theme.css" media="all" rel="stylesheet" type="text/css">
    <link href="./formGenerator_files/daterangepicker.css" rel="stylesheet">
    <link href="./formGenerator_files/component.css" rel="stylesheet">
	<link href="./formGenerator_files/ncBox.css" rel="stylesheet">
	<link href="./formGenerator_files/ncTable.css" rel="stylesheet">
	<link href="./formGenerator_files/ncTreeview.css" rel="stylesheet">
	<link href="./formGenerator_files/font-awesome-4.7/css/font-awesome.min.css" rel="stylesheet">
	<link href="./formGenerator_files/formGenerator.css" rel="stylesheet">
</head>

<body>
	<div class="custom-container">
	    <div class="row">
		    <div class="col-sm-2">
                <div class="row">
				    <div class="col-sm-12">
					    <div id="nodeTree" class="ncTreeview" oncontextmenu="return false;">
							<div class="ncTreeviewHead">文档层级结构&nbsp;
							</div>
							<div class="ncTreeviewSearch"></div>
							<div class="ncTreeviewBody">
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="col-sm-8">
                <div class="row">
					<div class="col-sm-1 btn-area">
						<button id="newForm" class="btn btn-default btn-sm"><i class="fa fa-plus"></i>&nbsp;布局</button>
					</div>
					<div class="col-sm-1 btn-area">
						<button id="newComponent" class="btn btn-default btn-sm"><i class="fa fa-plus"></i>&nbsp;组件&nbsp;<i class="fa fa-caret-down"></i></button>
					</div>
					<div class="col-sm-1 btn-area">
						<button id="editElement" class="btn btn-info btn-sm"><i class="fa fa-edit"></i>&nbsp;编辑</button>
					</div>
					<div class="col-sm-1 btn-area">
						<button id="deleteElement" class="btn btn-danger btn-sm"><i class="fa fa-minus"></i>&nbsp;删除</button>
					</div>
					<div class="col-sm-3 btn-area">
					    <div class="btn-group">
							<button id="saveTemplate" class="btn btn-default btn-sm"><i class="fa fa-download"></i>&nbsp;载入模板</button>
							<button id="saveTemplate" class="btn btn-primary btn-sm"><i class="fa fa-save"></i>&nbsp;存为模板</button>
						</div>
					</div>
					<div class="col-sm-2 btn-area">
						<button id="clearDesignStyle" class="btn btn-warning btn-sm"><i class="fa fa-shower"></i>&nbsp;清除设计样式</button>
					</div>
				</div>
				<div class="row margin">
					<div class="col-sm-12" style="padding:0px;">
					    <iframe id="formContent" frameborder="0" style="width:100%;border:1px solid #ddd;"></iframe>
					</div>
				</div>    
			</div>
			<div class="col-sm-2">
			    <div class="ncTable" id="elementProperties">
				    <div class="ncTableTitle">
				        <div style="font-size:14px;padding:5px 0px;">元素属性</div>
				    </div>
				    <div class="ncTableHead" nc-group-name="group" nc-group-sort="none">
				        <div class="ncTableRow">
				            <div class="ncTableHeadItem" nc-width="100" name="name">属性名</div>
				            <div class="ncTableHeadItem" nc-width="100" name="value" nc-editable="true">属性值</div>
							<div class="ncTableHeadItem" nc-width="100" nc-hidden="true" name="group">属性分组</div>
							<div class="ncTableHeadItem" nc-width="100" nc-hidden="true" name="code">属性CODE</div>
				        </div>
				    </div>
				    <div class="ncTableBody">
				    </div>
				 </div>
			</div>
		</div>
	</div>

	<div class="ncBox" id="newFormBox" style="width:900px">
		<div class="ncBoxHead">新增布局</div>
		<div class="ncBoxBody">
		    <div class="row" style="margin:10px 0px;">
			    <div class="col-sm-12" style="padding-left:0px;">
				    <h8>选择风格</h8>
				</div>
			</div>
		    <div class="row">
				<div class="col-sm-12" id="defaultLayout">
                    
				</div>
		    </div>
            <div class="row" style="margin:10px 0px;">
			    <div class="form-check" style="line-height: 1.2;">
				  <label class="form-check-label">
					<input type="checkbox" class="form-check-input" id="layCustom" value="">自定义
				  </label>
				</div>
			</div>
			<div class="row" id="customControl">
				<div class="col-sm-2">
				    <input type="text" class="form-control input-sm" name="rownum" placeholder="行数" disabled/>
				</div>
				<div class="col-sm-2">
				    <select type="text" class="form-control input-sm" name="colnum" placeholder="列数" disabled>
					    <option value="1">1</option>
						<option value="2">2</option>
						<option value="3">3</option>
						<option value="4">4</option>
						<option value="6">6</option>
						<option value="12">12</option>
					</select>
				</div>
			</div>
		</div>
		<div class="ncBoxFoot right">
			<button class="ncBoxBtn sm close">取消</button>
	        <button class="ncBoxBtn sm save">确定</button>
		</div>
	</div>

	<div class="ncBox" id="newComponentBox" style="width:500px">
		<div class="ncBoxHead">新增组件</div>
		<div class="ncBoxBody">
		    <div class="row" style="margin:10px 0px;">
			    <div class="col-sm-12" style="padding-left:0px;">
				    <h8>选择组件</h8>
				</div>
			</div>
		    <div class="row" id="componentArea">
				<div class="col-sm-2">
                    <button class="btn btn-default btn-sm" data-type="component-text">输入框</button>
				</div>
				<div class="col-sm-2">
				    <button class="btn btn-default btn-sm" data-type="component-select">下拉框</button>
				</div>
				<div class="col-sm-2">
                    <button class="btn btn-default btn-sm" data-type="component-radio">单选框</button>
				</div>
				<div class="col-sm-2">
				    <button class="btn btn-default btn-sm" data-type="component-checkbox">复选框</button>
				</div>
				<div class="col-sm-2">
				    <button class="btn btn-default btn-sm" data-type="component-button">按钮</button>
				</div>
				<div class="col-sm-2">
				    <button class="btn btn-default btn-sm" data-type="component-label">标签</button>
				</div>
		    </div>
		</div>
		<div class="ncBoxFoot right">
			<button class="ncBoxBtn sm close">取消</button>
	        <button class="ncBoxBtn sm save">确定</button>
		</div>
	</div>

	<div class="ncBox" id="elementEditBox" style="width:900px">
		<div class="ncBoxHead">
		    编辑组件-<span name="elementTypeName"></span>
		    <input type="hidden" name="elementType"/>
			<input type="hidden" name="elementKey"/>
		</div>
		<div class="ncBoxBody">
		    <form>
				<div class="row">
                    <div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>外边距</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="上-外边距(px)" data-style="margin-top" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="右-外边距(px)" data-style="margin-right" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="下-外边距(px)" data-style="margin-bottom" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="左-外边距(px)" data-style="margin-left" data-style-unit="px"/>
							</div>
						</div>
					</div>
					<div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>内边距</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="上-内边距(px)" data-style="padding-top" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="右-内边距(px)" data-style="padding-right" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="下-内边距(px)" data-style="padding-bottom" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="左-内边距(px)" data-style="padding-left" data-style-unit="px"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
                    <div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>边框</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="上-边框宽度(px)" data-style="border-top" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="右-边框宽度(px)" data-style="border-right" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="下-边框宽度(px)" data-style="border-bottom" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="左-边框宽度(px)" data-style="border-left" data-style-unit="px"/>
							</div>
						</div>
					</div>
					<div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>大小</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-4">
								<input type="text" class="form-control input-sm" placeholder="宽度(px)" data-style="width" data-style-unit="px"/>
							</div>
							<div class="col-sm-4">
								<input type="text" class="form-control input-sm" placeholder="高度(px)" data-style="height" data-style-unit="px"/>
							</div>
							<div class="col-sm-4">
								<input type="text" class="form-control input-sm" placeholder="行间距(px)" data-style="line-height" data-style-unit="px"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
                    <div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>背景</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-12">
								<input type="text" class="form-control input-sm" placeholder="背景色" data-style="background-color"/>
							</div>
						</div>
					</div>
					<div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>字体</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="字体大小" data-style="font-size" data-style-unit="px"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="字体颜色" data-style="color"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="字体粗细" data-style="font-weight"/>
							</div>
							<div class="col-sm-3">
								<input type="text" class="form-control input-sm" placeholder="字体类型" data-style="font-family"/>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
                    <div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>数据源</h5>
							</div>
						</div>
						<div class="row">
							<div class="col-sm-6">
								<input type="text" class="form-control input-sm" placeholder="显示名称"  data-property="display-name"/>
							</div>
							<div class="col-sm-6">
								<input type="text" class="form-control input-sm" placeholder="数据源名称"  data-property="datasource-name"/>
							</div>
						</div>
					</div>
					<div class="col-sm-6">
					    <div class="row">
							<div class="col-sm-12">
								<h4>位置</h5>
							</div>
						</div>
						<div class="row" style="font-size:14px;">
							<div class="col-sm-3">
								<label><input type="radio" name="textAlign" data-style="text-align" value="left" checked/>&nbsp;居左</label>
							</div>
							<div class="col-sm-3">
								<label><input type="radio" name="textAlign" data-style="text-align" value="center"/>&nbsp;居中</label>
							</div>
							<div class="col-sm-3">
								<label><input type="radio" name="textAlign" data-style="text-align" value="right"/>&nbsp;居右</label>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>
		<div class="ncBoxFoot right">
			<button class="ncBoxBtn sm close">取消</button>
	        <button class="ncBoxBtn sm save">确定</button>
		</div>
	</div>
</body>

<script src="./formGenerator_files/jquery.min.js" type="text/javascript"></script>
<script src="./formGenerator_files/bootstrap.min.js" type="text/javascript"></script>
<script src="./formGenerator_files/piexif.js" type="text/javascript"></script>
<script src="./formGenerator_files/sortable.js" type="text/javascript"></script>
<script src="./formGenerator_files/fileinput.js" type="text/javascript"></script>
<script src="./formGenerator_files/zh.js" type="text/javascript"></script>
<script src="./formGenerator_files/theme.js" type="text/javascript"></script>
<script src="./formGenerator_files/moment.js"></script>
<script src="./formGenerator_files/daterangepicker.js"></script>
<script src="./formGenerator_files/founder.js"></script>
<script src="./formGenerator_files/ncBox.js"></script>
<script src="./formGenerator_files/ncTable.js"></script>
<script src="./formGenerator_files/ncTreeview.js"></script>
<script src="./formGenerator_files/jquery.serializeobject.js"></script>

<script>
    var fg = formGenerator = {
	    initialize : function(){
			var myself = this;
		    $(function(){
				myself.buildLayoutPreview();

				for(var i in myself){
				    if(myself[i].init){
					    myself[i].init();
					}
				}
			});
		},
		//表单风格库
		style : {
			//默认样式
			defaultx : "Bootstrap",
		    Bootstrap : {
				lib : [
				    '<link href="./formGenerator_files/bootstrap.min.css" rel="stylesheet" type="text/css">',
					'<link href="./formGenerator_files/formContent.css" rel="stylesheet" type="text/css">',
					'<script src="./formGenerator_files/jquery.min.js" type="text/javascript"><\/script>',
					'<script src="./formGenerator_files/bootstrap.min.js" type="text/javascript"><\/script>',
					'<script src="./formGenerator_files/formContent.js" type="text/javascript"><\/script>'
				],
				elementTemplate : {
					"layout-row":{name:"行", tag:"div", html:""},
					"layout-column":{name:"列", tag:"div", html:""},
					"component-text":{name:"输入框", tag:"input", html:"<input type='text' class='form-control input-sm' data-type='component-text' data-key='{data-key}'/>"},
					"component-date":{name:"时间选择器", tag:"input", html:"<input type='text' class='form-control input-sm' data-type='component-date' data-key='{data-key}'/>"},
					"component-label":{name:"文本标签", tag:"label", html:"<label data-type='component-label' data-key='{data-key}'>标签</label>"},
					"component-radio":{name:"单选框", tag:"label", html:"<label data-type='component-radio' data-key='{data-key}'><input type='radio'/><span>单选框</span></label>"},
					"component-checkbox":{name:"复选框", tag:"label", html:"<label data-type='component-checkbox' data-key='{data-key}'><input type='checkbox'/><span>复选框</span></label>"},
					"component-button":{name:"按钮", tag:"button", html:"<button class='btn btn-default btn-sm' data-type='component-button' data-key='{data-key}'>按钮</button>"},
					"component-select":{name:"下拉框", tag:"select", html:"<select class='form-control input-sm' data-type='component-select' data-key='{data-key}'></select>"},
				}
		    },
			get : function(){
				return this[this.defaultx];
			}
		},
		//封装对表单区元素查询的操作
		querySelector : function(selector){
            return this.formContent.innerRef().find(selector);
		},
		//根据组件类型标签名
		getElementTagByType : function(type){
			if(!fg.style.get().elementTemplate[type]) return "";
			return fg.style.get().elementTemplate[type].tag;
		},
		//根据组件类型获取组件名称
		getElementNameByType : function(type){
			if(!fg.style.get().elementTemplate[type]) return "";
			return fg.style.get().elementTemplate[type].name;
		},
		//根据组件类型获取组件HTML
		getComponentHtml : function(type){
			var t = type.substr("component-".length);
			return fg.style.get().elementTemplate[type].html.replace('{data-key}', fg.getUUID(t+"-"));
		},
		//获取布局HTML
		getLayoutHtml : function(layoutData, colnum){
			var ld = [];

			if(Object.prototype.toString.call(layoutData) != '[object Array]'){
				ld.push(layoutData);
			}else{
				ld = layoutData;
			}
            
			colnum = colnum?colnum:1;

		    var html = "";
		    for(var i = 0; i < ld.length; i++){
                var item = ld[i];
                html += '<div class="row panel-f" data-type="layout-row" '
				        + 'data-key="'+fg.getUUID("row-")+'">';
			    
				for(var j = 0; j < item.colnum; j++){
				    html += '<div class="col-sm-'+(12/item.colnum)+' border-f" data-type="layout-column" data-key="'+fg.getUUID("column-")+'" style="height:30px;"></div>';
				}

                html += '</div>';
			}
			return html;
		},
		//获取布局预览HTML
		getPreviewHtml : function(layoutData){
			var ld = [];

			if(Object.prototype.toString.call(layoutData) != '[object Array]'){
				ld.push(layoutData);
			}else{
				ld = layoutData;
			}
            
		    var html = "";
		    for(var i = 0; i < ld.length; i++){
				if(i%2 == 0){
					html += "<div class='row'>";
				}

                var item = ld[i];
                html += '<div class="col-sm-6 custom"><div class="row panel-p" data-type="layout-row" '
				        + 'data-key="'+item.key+'">';
			    
				for(var j = 0; j < item.colnum; j++){
				    html += '<div class="col-sm-'+(12/item.colnum)+' border-p" data-type="layout-column" style="height:30px;"></div>';
				}

                html += '</div></div>';

				if(i%2 != 0){
					html += "</div>";
				}
			}
			return html;
		},
		//构建布局预览HTML
		buildLayoutPreview : function(){
			var $defaultLayout = $("#defaultLayout");
			$defaultLayout.html(this.getPreviewHtml(this.data.initLayout));
		},
		//数据处理
		data : {
		    initLayout : [
			    { colnum : 1, key : 1, type : "layout-row"},
				{ colnum : 2, key : 2, type : "layout-row"},
				{ colnum : 3, key : 3, type : "layout-row"},
				{ colnum : 4, key : 4, type : "layout-row"},
				{ colnum : 6, key : 6, type : "layout-row"},
				{ colnum : 12, key : 8, type : "layout-row"}
			],
			getLayout : function(key){
				for(var i = 0; i < this.initLayout.length; i++){
				    var item = this.initLayout[i];
					if(item.key == key){
					    return item;
					}
				}
				return null;
			}
		},
		//弹出框定义区
		box : {
			init : function(){
			    for(var i in this){
				    if(this[i].define){
					    this[i].define();
					}
				}
			},
			//布局
		    newFormBox : {
			    define : function(){
				    $("#newFormBox").ncBox({event : {
					    save : function(){
							var rownum = 1;
						    if(fg.layoutWay == 'custom'){
								var $cc = $("#customControl");
								rownum = $cc.find("input[name='rownum']").val();
								var l = {
									colnum : $cc.find("select[name='colnum']>option:selected").val(),
									type: "layout-row"
								};
                                fg.data.setLayout = l;
							}
                            
							if(fg.data.setLayout){
								for(var i = 0; i < rownum; i++){
									 fg.formContent.add(fg.data.setLayout);
								}
							}

							this.close();
						}
					}});
				}
			},
			//组件
			newComponentBox : {
			    define : function(){
					myself = this;
					$("#componentArea").find("button[data-type]").click(function(){
					    myself.currentComponent = $(this).attr("data-type");		    
					});
				    $("#newComponentBox").ncBox({event : {
					    save : function(){
                            var type = myself.currentComponent;
                            fg.formContent.add({type:type});

							this.close();
						}
					}});
				}
			},
			elementEditBox : {
				define : function(){
                    $("#elementEditBox").ncBox({event : {
					    save : function(){
							var styles = '';
							var properties = {};

							var $eles = $("#elementEditBox form").find("input,select");
							$eles.each(function(){
							    var $e = $(this);
                                var val = $e.val();

								if($e[0].tagName.toLowerCase() == "input"){
								    if($e.attr("type") == "radio" || $e.attr("type") == "checkbox"){
									    if(!$e.prop("checked")) return;
									}
								}

                                if(val && val.trim()){
								    var style = $e.attr("data-style");
									var unit =  $e.attr("data-style-unit");
									if(style){
										styles += style+":"+val+(unit?unit:"")+";";
									}

									var pro = $e.attr("data-property");
									if(pro){
										properties[pro] = val;
									}
								}
							});

                            var $eeb = $("#elementEditBox");
                            var key = $eeb.find("input[name='elementKey']").val();
                            var type = $eeb.find("input[name='elementType']").val();
                            
							fg.formContent.setStyle(key, type, styles);
                            fg.formContent.setProperty(key, type, properties);

							this.close();
						}
					}});
				}
			},
			panel : {
			    define : function(){
				    $(".row.panel-p").click(function(){
						$(".row.panel-p").removeClass("focus");
					    $(this).addClass("focus");

                        fg.data.setLayout = fg.data.getLayout($(this).attr("data-key"));
					});
				}
			}
		},
		//表单显示区
		formContent : {
			init : function(){
			    var defaultStyle = fg.style.get();
				var doc = this.ref()[0].contentWindow.document;
				
				//doc.designMode="on";

				for(var i = 0; i < defaultStyle.lib.length; i++){
				    doc.write(defaultStyle.lib[i]);
				}

                doc.write("<body style='padding:0px 15px;'></body>");

				this.ref().height($(window).height() - 60);
			},
			ref : function(){
			    return $("#formContent");
			},
			innerRef : function(){
			    return this.ref()[0].contentWindow.$("body");
			},
			bindEvent : function(){
				var $elements = this.innerRef().find("[data-key]");
                
				$elements.unbind("click");
				$elements.bind("click", function(e){
					fg.treeview.nodeTree.setCurrentNode($(this).attr("data-key"));
                    e.stopPropagation();
				});
			},
		    add : function(element){
				var ele = $.extend({}, element);

				var html = "";
				var $body = this.innerRef();

				if(ele.type.indexOf("layout-") == 0){
				    html = fg.getLayoutHtml(ele, 1, "f");
				}else if(ele.type.indexOf("component-") == 0){
				    html = fg.getComponentHtml(ele.type);
				}

                var node = fg.treeview.nodeTree.getCurrentNode();
                var tag = fg.getElementTagByType(node.type);

                var $html = $(html);
                if(node.id == "root"){
					$body.append($html);
				}else{
					var $ele = $body.find(tag+"[data-key='"+node.id+"']:first");
					$ele.append($html);
				}

				ele.key = $html.attr("data-key");

				//写入树节点
				var name = fg.getElementNameByType(ele.type);
				fg.treeview.nodeTree.add(ele.key, name, "", {type:ele.type});

				var $childs = $body.find(tag+"[data-key='"+ele.key+"']").children("div[data-key]");
				
				$childs.each(function(){
					var $el = $(this);
					fg.treeview.nodeTree.add(
						$el.attr("data-key"), 
						fg.getElementNameByType($el.attr("data-type")), 
						ele.key, 
						{type : $el.attr("data-type")}
					);
				});

				this.bindEvent();
			},
			modify : function(){
			},
			remove : function(key, type){
				var $ele = this.getDomElement(key, type);
				if($ele.length == 0) return;
                $ele.remove();

				fg.treeview.nodeTree.remove(key);
			},
			setStyle : function(key, type, styles){
				var $ele = this.getDomElement(key, type);
				if($ele.length == 0) return;
				if(styles){
				    $ele.attr("style", styles);
				}
			},
			setProperty : function(key, type, properties){
                var $ele = this.getDomElement(key, type);
				if($ele.length == 0) return;
				for(var i in properties){
					var pro = properties[i];
				    $ele.attr("data-"+i, pro);
                    if(i == "display-name"){
						var tag = $ele[0].tagName;
                        if(tag.toLowerCase() == "label"){
							if($ele.find("span").length == 0){
							    $ele.append("<span></span>");
							}
							$ele.find("span").text(pro);
						}else if(tag.toLowerCase() == "input"){
						    $ele.val(pro);
						}else if(tag.toLowerCase() == "div"){
						    $ele.text(pro);
						}else if(tag.toLowerCase() == "select"){
						    $ele.val(pro);
						}else if(tag.toLowerCase() == "button"){
						    $ele.html(pro);
						}
					}
				}
			},
			getStyleWithProperty : function(key, type){
			    var $ele = this.getDomElement(key, type);
				if($ele.length == 0) return;
                
				var sty = {};
				var style = $ele.attr("style");
				if(style){
					var styles = style.split(";");
					for(var i=0; i<styles.length; i++){
						var s = styles[i];
						var ss = s.split(":");
						sty[ss[0]] = ss[1];
					}
				}

                var attrs = {};
				$.each($ele[0].attributes, function() {
					var index = this.name.indexOf("data-");
					if(index > -1){
						var n = this.name.substr(index + 5, this.name.length - 5);
						attrs[n] = this.value;
					}
				});

				return {styles: sty, properties: attrs};
			},
			getDomElement : function(key, type){
				return this.innerRef().find(fg.getElementTagByType(type)+"[data-key='"+key+"']");
			}
		},
		//表格区
		table : {
			init : function(){
			    for(var i in this){
				    if(this[i].define){
					    this[i].define();
					}
				}
			},
			elementProperties : {
				ref :function(){
				    return $("#elementProperties");
				},
				get : function(){
					return this.ref().getNcTable();
				},
				define : function(){
					var ep = this;
					var $ep = this.ref(),
					    nt = $ep.ncTable({
							selectRowMode : "none",
							dataGroup : {
								formatter : function(item){
									return "<span style='font-size:12px;font-weight:bold;'>"+item.group+"</span>";
								}
							},
							event : {
								valueChanged : function(rowIndex, cellName, cellValue){
									var rowData = this.getCurrentRowData(rowIndex);
									fg.currentElement.setProp(rowData.code, cellValue);
								}
							}
					    });

					nt.setHeight($(window).height() - 22);

                    var propData = [];
                    for(var i in fg.currentElement.propName.get()){
						var item = fg.currentElement.propName.get()[i];
						if(item.hidden) continue;
						propData.push({name: item.display, value: "", code: i, group: item.group});
                    }

					nt.loadLocalData(propData);
					nt._groupExpandOrCollpaseAll(true);
				}
			}
		},
		//事件定义区
		event : {
			init : function(){
			    for(var i in this){
				    if(this[i].define){
					    this[i].define();
					}
				}
			},
		    newForm : {
			    define : function(){
				    $("#newForm").click(function(){
					    $("#newFormBox").getNcBox().show();
					});
				}
			},
			newComponent : {
			    define : function(){
					$("#newComponent").click(function(){
						$("#newComponentBox").getNcBox().show();
					});
				}
			},
			editElement : {
			    define : function(){
				    $("#editElement").click(function(){
						var node = fg.treeview.nodeTree.getCurrentNode();
						var $eeb = $("#elementEditBox");
						
						$.clearAndInitForm($eeb.find("form"));

						$eeb.find("span[name='elementTypeName']").text(fg.getElementNameByType(node.type));
						$eeb.find("input[name='elementType']").val(node.type?node.type:"");
						$eeb.find("input[name='elementKey']").val(node.id);
                        
                        var sp = fg.formContent.getStyleWithProperty(node.id, node.type);
						var styles = sp.styles;
						var properties = sp.properties;

                        $eeb.find("form input,form select").each(function(){
						    var $this = $(this);
							var s = $this.attr("data-style");
							var unit = $this.attr("data-style-unit");
							var val = styles[s];

							if(val){
								val = val.replace(unit, "");
							    if($this.attr("type") == "radio" || $this.attr("type") == "checkbox"){
								    if($this.val() == val){
									    $this.prop("checked", true);
									}
								}else{
								    $this.val(val);
								}
							}

							var dp = $this.attr("data-property");
							if(dp && properties[dp]){
							    $this.val(properties[dp]);
							}
						});

						$eeb.getNcBox().show();
					});
				}
			},
			deleteElement : {
			    define : function(){
				    $("#deleteElement").click(function(){
						var node = fg.treeview.nodeTree.getCurrentNode();
                        fg.formContent.remove(node.id, node.type);
					});
				}
			},
			layCustom : {
			    define : function(){
					fg.layoutWay = 'default';
				    $("#layCustom").click(function(){
						var check = $(this).prop("checked");
						if(check){
							fg.layoutWay = 'custom';
						    $("#customControl").find("input,select").removeAttr("disabled");
						}else{
							fg.layoutWay = 'default';
						    $("#customControl").find("input,select").attr("disabled","disabled");
						}
					});
				}
			},
			clearDesignStyle : {
			    define : function(){
					var myself = this;
				    $("#clearDesignStyle").click(function(){
						if(myself.isClear){
                            var $ele = fg.querySelector(".panel-c,.border-c");
							$ele.removeClass("panel-c").addClass("panel-f");
							$ele.removeClass("border-c").addClass("border-f");
						}else{
						    var $ele = fg.querySelector(".panel-f,.border-f");
							$ele.removeClass("panel-f").addClass("panel-c");
							$ele.removeClass("border-f").addClass("border-c");
						}

						myself.isClear = !myself.isClear;
					});
				}
			}
		},
		//树状视图区
		treeview : {
			init : function(){
			    for(var i in this){
				    if(this[i].define){
					    this[i].define();
					}
				}
			},
		    nodeTree : {
				ref : function(){
				    return $("#nodeTree");	
				},
			    define : function(){
					var nt = this;
				    this.ref().ncTreeview({
						 showIcon:true,
					     nodeClick:function(node, e){
							 nt.setCurrentNode(node.id);
					     },
						 nodeMouseDown:function(node, e){
                             if(e.which == 3){
                                 fg.treeview.nodeTree.contextMenu.show(node, e);
						     }
					     }
				    });

					var tv = this.ref().getNcTreeview();

					tv.setHeight($(window).height() - 30);
					tv.load([{id:"root", name:"模板"}]);
					tv.setCurrentNode("root");
				},
				add : function(id, name, pid, attributes){
					var tv = this.ref().getNcTreeview();
					pid = pid?pid:tv.getCurrentNode().id;

				    tv.insertNodeObj({id:id, name:name, pid:pid, attributes:attributes});
				},
				remove : function(id){
				    this.ref().getNcTreeview().deleteNode(id);
				},
				getCurrentNode : function(){
				    return this.ref().getNcTreeview().getCurrentNode();
				},
				setCurrentNode : function(id){
				    this.ref().getNcTreeview().setCurrentNode(id, true, true);
					
					fg.querySelector("[data-key]").removeClass("focus");

				    var $ele = fg.querySelector("[data-key='"+id+"']:first");
				    $ele.addClass("focus");

				    var propData = fg.currentElement.set($ele);
				    var nt = fg.table.elementProperties.get();

				    nt.loadLocalData(propData);
				    nt._groupExpandOrCollpaseAll(true);
				},
				//右键菜单
				contextMenu : {
					show : function(node, e){
						var htm = '<ul id="nodeRightMenu" class="nodeRightMenu">' +
								      '<li name="copy" command="copyElement"><a><i class="fa fa-copy" style="width:30px"></i>复制元素</a></li>' +
									  '<li name="paste" command="pasteElement"><a><i class="fa fa-paste" style="width:30px"></i>粘贴元素</a></li>' +
									  '<li name="delete" command="deleteElement"><a><i class="fa fa-trash-o" style="width:30px;font-size:17px;"></i>删除元素</a></li>' +
								  '</ul>';

						if($("#nodeRightMenu").length == 0){
							$("body").append(htm);
							$("body").click(function(e){
								var $menu = $("#nodeRightMenu");
								if(e.pageX < $menu.offset().left || e.pageX > $menu.offset().left + $menu.width() ||
								   e.pageY < $menu.offset().top || e.pageY > $menu.offset().top + $menu.height()){
									$menu.removeClass("show");
								}
                              
							});
							$("#nodeRightMenu").find("li").click(function(){
								var $this = $(this), com = $this.attr("command"),
								    node = fg.treeview.nodeTree.getCurrentNode(),
								    element = fg.querySelector("[data-key='"+node.id+"']:first");
								fg.command[com].call($this, node, element);
                                
								$menu.removeClass("show");
							});
						}

                        var $menu = $("#nodeRightMenu"), $node = $(e.target);
						$menu.css({left: $node.offset().left, top: $node.offset().top + $node.height() + 5});
                        $menu.addClass("show");
					}
				}
			}
		},
		//当前元素
		currentElement : {
			get : function(){
                return this._element;
			},
			set : function($element){
				var propMap = {};
				var style = $element.attr("style"),
					display = $element.attr("data-display-name"),
					datasource = $element.attr("data-datasource-name");

				propMap["datasource-name"] = datasource;
				propMap["display-name"] = display;

				//解析样式
				var styles = style ? style.split(";") : [];
				for(var i = 0; i < styles.length; i++){
					var kv = styles[i].split(":");
					if(!kv[0].trim()) continue;
					propMap[kv[0].trim()] = kv[1] ? kv[1].trim() : "";
				}
				
				//分解样式
				var propData = {};
				for(var i in this.propName.get()){
					var item = this.propName.get()[i];
					if(item.children && propMap[i]){
						var p = this.propName.resolve(i, item.children, propMap[i]);
						for(var j in p){
							propData[j].value = p[j];
						}
					}else if(!item.hidden){
						propData[i] = {name: item.display, value: propMap[i], code: i, group: item.group};
					}
				}

                this._element = $element;
				this.setPropData(propData);

                //生成返回列表
				var result = [];
				for(var j in propData){
					result.push(propData[j]);
				}

				return result;
			},
			setProp : function(key, value){
				if(!this._element) return;

				if(!this._propData){
					this._propData = {};
				}

                this._propData[key].value = value;

                var style = [], custom = [];
                for(var i in this._propData){
					var item = this._propData[i],
					    isStyle = this.propName.isStyle(item.code);
                    if(isStyle){
						if(item.value){
							style.push(item.code + ":" + this.propName.getUnit(item.code, item.value));
						}
                    }else{
                        custom.push({name: item.code, value: item.value});
                    }
                }

                if(style.length > 0){
					this._element.attr("style", style.join(";"));
                }
                
				for(var j in custom){
					this._element.attr("data-" + custom[j].name, custom[j].value);
					if(custom[j].name == "display-name"){
						this.setValue(custom[j].value);
					}
				}
			},
			setValue : function(value){
                var type = this.getElementType();
				if(type == "component-label"){
                    this._element.text(value);
				}else if(type == "component-text"){
					this._element.val(value);
				}else if(type == "component-radio"){
					this._element.find("span").text(value);
				}else if(type == "component-checkbox"){
					this._element.find("span").text(value);
				}else if(type == "component-button"){
					this._element.text(value);
				}else if(type == "component-select"){
				}else if(type == "component-date"){
				}
			},
			getElementType : function(){
			    return this._element.attr("data-type");	
			},
			setPropData : function(propData){
				this._propData = this._propData ? this._propData : {};
				this._propData = $.extend(this._propData, propData);
			},
			propName : {
				defaultx : "_Zh_CN",
				_Zh_CN : {
					"datasource-name" : {display: "数据源名称", group:"数据源", type:"custom"},
					"display-name" : {display: "显示文本", group:"基本属性", type:"custom"},
					"text-align" : {display: "文本位置", group:"基本属性", type:"style"},
					"background-color" : {display: "背景色", group:"基本属性", type:"style"},
					"color" : {display: "前景色", group:"基本属性", type:"style"},
					"width" : {display: "宽度", group:"大小", type:"style", unit:"px"},
					"height" : {display: "高度", group:"大小", type:"style", unit:"px"},
					"line-height" : {display: "行间距", group:"大小", type:"style", unit:"px"},
					"font-family" : {display: "字体类型", group:"字体", type:"style"},
					"font-size" : {display: "字体大小", group:"字体", type:"style"},
					"font-weight" : {display: "字体粗细", group:"字体", type:"style"},
					"margin-top" : {display: "外边距-上", group:"外边距", type:"style", unit:"px"},
					"margin-right" : {display: "外边距-右", group:"外边距", type:"style", unit:"px"},
					"margin-bottom" : {display: "外边距-下", group:"外边距", type:"style", unit:"px"},
					"margin-left" : {display: "外边距-左", group:"外边距", type:"style", unit:"px"},
					"margin" : {display: "外边距", group:"外边距", type:"style", hidden:true, 
								children:["margin-top","margin-right","margin-bottom","margin-left"], unit:"px"},
					"padding-top" : {display: "内边距-上", group:"内边距", type:"style", unit:"px"},
					"padding-right" : {display: "内边距-右", group:"内边距", type:"style", unit:"px"},
					"padding-bottom" : {display: "内边距-下", group:"内边距", type:"style", unit:"px"},
					"padding-left" : {display: "内边距-左", group:"内边距", type:"style", unit:"px"},
					"padding" : {display: "内边距", group:"外边距", type:"style", hidden:true, 
								 children:["padding-top","padding-right","padding-bottom","padding-left"], unit:"px"},
					"border-top" : {display: "边框-上", group:"边框", type:"style", unit:"px"},
					"border-right" : {display: "边框-右", group:"边框", type:"style", unit:"px"},
					"border-bottom" : {display: "边框-下", group:"边框", type:"style", unit:"px"},
					"border-left" : {display: "边框-左", group:"边框", type:"style", unit:"px"},
					"border" : {display: "边框", group:"外边距", type:"style", hidden:true, 
								children:["border-top","border-right","border-bottom","border-left"], unit:"px"}
				},
				//分解样式
				resolve : function(name, children, value){
					if(!value) value = "";

					var map = {};

					if(name == "margin" || name == "padding"){
						var arr = value ? value.split(" ") : [];
						for(var i = 0; i < children.length; i++){
							if(arr.length == 1){
								map[children[i]] = arr[0];
							}else if(arr.length == 2){
								map[children[i]] = arr[i%2];
							}else if(arr.length == 3){
								map[children[i]] = i < 3 ? arr[i] : 0;
							}else if(arr.length == 4){
								map[children[i]] = arr[i];
							}else{
								map[children[i]] = 0;
							}
						}
					}else if(name == "border"){
						for(var i = 0; i < children.length; i++){
							map[children[i]] = value ? value : 0;
						}
					}

					return map;
				},
				get : function(){
					return this[this.defaultx];
				},
				exist : function(name){
					return this[this.defaultx][name];
				},
				isStyle : function(name){
					var prop = this[this.defaultx][name];
					return prop && prop.type == "style";
				},
				isCustom : function(name){
					var prop = this[this.defaultx][name];
					return prop && prop.type == "custom";
				},
				getUnit : function(name, value){
					if(!value) return "";

					var prop = this[this.defaultx][name];
					var unit = prop.unit ? prop.unit : "";

                    return value.indexOf(unit) > -1 ? value : (value + unit);
				}
			}
		},
		getUUID : function(prefix){
			var s = [];
			var hexDigits = "0123456789abcdef";

			for (var i = 0; i < 36; i++) {
				s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
			}

			s[14] = "4";
			s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
			s[8] = s[13] = s[18] = s[23] = "-";

			var uuid = s.join("");

			return prefix + uuid;
		},
		//通用命令
		command : {
			copyElement : function(node, element){
				alert(element[0].outerHTML);
			},
			pasteElement : function(node, element){
				
			},
			deleteElement : function(node, element){
				
			}
		}
	}

	fg.initialize();
</script>

</html>